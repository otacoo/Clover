# This is a configuration file for R8/ProGuard.

# Don't optimize — build.gradle uses proguard-android.txt (non-optimizing base)
# and -dontoptimize here for consistent, predictable release shrinking.
-optimizations code/simplification/arithmetic,code/simplification/cast,code/simplification/field,code/simplification/variable,code/propagation/variable
-dontpreverify
-dontusemixedcaseclassnames
-dontskipnonpubliclibraryclasses
-verbose

# Keep sourcefile and line numbers for crash report inspection
-keepattributes SourceFile,LineNumberTable

# Keep annotations, generic signatures (needed by OrmLite + Feather DI), and exceptions
-keepattributes *Annotation*
-keepattributes Signature
-keepattributes Exceptions
-keepattributes InnerClasses

-keep public class com.google.vending.licensing.ILicensingService
-keep public class com.android.vending.licensing.ILicensingService

# For native methods
-keepclasseswithmembernames class * {
    native <methods>;
}

# Keep setters in Views so animations still work
-keepclassmembers public class * extends android.view.View {
   void set*(***);
   *** get*();
}

# Keep Activity onClick handlers referenced from XML
-keepclassmembers class * extends android.app.Activity {
   public void *(android.view.View);
}

# Enumerations
-keepclassmembers enum * {
    public static **[] values();
    public static ** valueOf(java.lang.String);
}

-keepclassmembers class * implements android.os.Parcelable {
  public static final android.os.Parcelable$Creator CREATOR;
}

-keepclassmembers class **.R$* {
    public static <fields>;
}

# ── OrmLite (uses reflection to read @DatabaseTable / @DatabaseField) ────────
-keep class com.j256.**
-keepclassmembers class com.j256.** { *; }
-keep enum com.j256.**
-keepclassmembers enum com.j256.** { *; }
-keep interface com.j256.**
-keepclassmembers interface com.j256.** { *; }

# ── Clover database models ────────────────────────────────────────────────────
-keep class org.otacoo.chan.core.model.orm.** { *; }

# ── Clover JSON models ───────────────────────────────────────────────────────
-keep class org.otacoo.chan.core.model.json.** { *; }

# ── Core database layer (DatabaseManager, DatabaseSavedReplyManager, etc.) ───
# IMPORTANT: missing this was the likely cause of the post-marking bug.
# R8 could shrink Callable lambdas and synchronized blocks inside these classes.
-keep class org.otacoo.chan.core.database.** { *; }

# ── Site loader and parser (ChanReaderRequest, PostParseCallable — calls isSaved) ─
-keep class org.otacoo.chan.core.site.loader.** { *; }
-keep class org.otacoo.chan.core.site.parser.** { *; }

# ── Main application and DI entry points ─────────────────────────────────────
-keep class org.otacoo.chan.Chan { *; }
-keep class org.otacoo.chan.ChanApplication { *; }

# ── Sites ────────────────────────────────────────────────────────────────────
-keep class org.otacoo.chan.core.site.sites.** { *; }
-keep interface org.otacoo.chan.core.site.Site { *; }
-keep class org.otacoo.chan.core.site.SiteBase { *; }
-keep class org.otacoo.chan.core.site.common.** { *; }
-keep class org.otacoo.chan.core.site.SiteRegistry { *; }
-keep interface org.otacoo.chan.core.site.SiteUrlHandler { *; }
-keep class org.otacoo.chan.core.site.SiteIcon { *; }

# ── Feather DI (uses reflection to inject @Inject constructors and fields) ───
-keepclassmembers class * {
    @org.codejargon.feather.Provides *;
    @javax.inject.Inject <init>(...);
    @javax.inject.Inject *;
}
-keep class org.codejargon.feather.** { *; }
# Secondary rule to keep no-arg constructors and injected members
-keepclassmembers,allowobfuscation class * {
    @javax.inject.* *;
    <init>();
}

# ── Controllers, presenters, managers (kept to protect Feather-injected code) ─
-keep class org.otacoo.chan.ui.controller.** { *; }
-keep class org.otacoo.chan.core.presenter.** { *; }
-keep class org.otacoo.chan.core.manager.** { *; }
-keep class org.otacoo.chan.core.repository.** { *; }
-keep class org.otacoo.chan.ui.adapter.** { *; }
-keep class org.otacoo.chan.ui.view.** { *; }

# ── EventBus 2.x (subscriber methods discovered by name at runtime) ──────────
-keepclassmembers class ** {
    public void onEvent*(**);
}

# ── GIF library ──────────────────────────────────────────────────────────────
-keep public class pl.droidsonroids.gif.GifIOException{<init>(int);}
-keep class pl.droidsonroids.gif.GifInfoHandle{<init>(long,int,int,int);}

# ── OkHttp 3.x ───────────────────────────────────────────────────────────────
-dontwarn okhttp3.**
-dontwarn okio.**
-dontwarn java.nio.**
-dontwarn javax.annotation.**
-dontwarn org.codehaus.mojo.**
-dontwarn org.conscrypt.**

# ── Jsoup ────────────────────────────────────────────────────────────────────
-keeppackagenames org.jsoup.nodes

# ── JavaScript interfaces ─────────────────────────────────────────────────────
-keepclassmembers class * {
    @android.webkit.JavascriptInterface <methods>;
}

# ── Media3 / ExoPlayer ───────────────────────────────────────────────────────


# ── Suppress leftover warnings ───────────────────────────────────────────────
-dontwarn android.support.**
-dontwarn org.slf4j.**
-dontwarn javax.**
